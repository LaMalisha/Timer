<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Analizzatore Spettrale</title>
    <!-- Caricamento di Tailwind CSS per uno stile moderno e responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Impostazioni di configurazione e font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* 1. Animazione del Bagliore Pulsante */
        @keyframes pulse-glow {
            0% { text-shadow: 0 0 8px rgba(0, 255, 255, 0.4); }
            50% { text-shadow: 0 0 20px rgba(0, 255, 255, 0.8), 0 0 10px rgba(0, 255, 255, 1); }
            100% { text-shadow: 0 0 8px rgba(0, 255, 255, 0.4); }
        }

        /* 2. Stile del Testo Rimosso da Qualsiasi Contenitore */
        .timer-text {
            font-size: 4.5rem; /* Testo grande e prominente */
            letter-spacing: 4px;
            font-weight: 800;
            color: #e2e8f0; 
            background-color: transparent; 
            padding: 0; /* Rimuovi padding */
            /* SOLO NEON GLOW SUL TESTO */
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.6);
            /* Centrato e libero di fluttuare */
            z-index: 10;
        }
        
        /* 3. Applicazione del Glow Pulsante al Testo in Esecuzione */
        .timer-running {
            animation: pulse-glow 2s infinite alternate ease-in-out;
        }

        /* --- STILI ANALIZZATORE SPETTRALE (VISUALIZZATORE AUDIO) --- */

        .visualizer-container {
            display: flex;
            align-items: flex-end; /* Le barre crescono dal basso */
            justify-content: space-between;
            width: 100%;
            height: 100%;
            padding: 1rem;
            position: absolute; /* Copre il timer senza interferire con i numeri */
            top: 0;
            left: 0;
            pointer-events: none; /* Rende il visualizzatore cliccabile attraverso */
        }

        .audio-bar {
            width: 6px; /* Larghezza della barra */
            background-color: #00ffff; /* Colore Neon Cyan di default */
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
            border-radius: 3px 3px 0 0; /* Angoli arrotondati in alto */
            transition: height 0.1s linear;
        }

        /* Classi dinamiche per il colore/glow del visualizzatore */
        .focus-style .audio-bar {
            background-color: #00ffff; /* Cyan */
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }
        .workout-style .audio-bar {
            background-color: #34d399; /* Emerald Green */
            box-shadow: 0 0 10px rgba(52, 211, 153, 0.8);
        }
        
        /* Animazione per simulare il movimento delle onde sonore */
        @keyframes bounce-bar-1 { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }
        @keyframes bounce-bar-2 { 0%, 100% { transform: scaleY(0.8); } 40% { transform: scaleY(0.4); } }
        @keyframes bounce-bar-3 { 0%, 100% { transform: scaleY(1); } 60% { transform: scaleY(0.6); } }
        @keyframes bounce-bar-4 { 0%, 100% { transform: scaleY(0.4); } 70% { transform: scaleY(0.9); } }
        
        /* Posizionamento del Timer e Visualizzatore */
        .timer-visual-area {
            position: relative;
            width: 300px;
            height: 150px; /* Altezza per il visualizzatore e il testo */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <h1 class="text-4xl font-bold mb-10 text-cyan-400">Timer Analizzatore Spettrale</h1>

    <main class="w-full max-w-6xl flex flex-col lg:flex-row gap-8">
        
        <!-- SEZIONE TIMER PRINCIPALE -->
        <section class="lg:w-1/2 bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-semibold mb-6 text-center text-cyan-300">Il Tuo Timer</h2>

            <!-- Display del Timer con Visualizzatore -->
            <div class="flex justify-center">
                <div id="timerVisualArea" class="timer-visual-area">
                    
                    <!-- Il Testo del Timer (completamente libero e neon) -->
                    <div id="timerDisplay" class="timer-text">00:00:00</div>

                    <!-- Visualizzatore Audio (nuovo elemento) -->
                    <div id="visualizerContainer" class="visualizer-container">
                        <!-- Le barre saranno generate qui via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Input per Impostare il Tempo (Nessun cambiamento qui) -->
            <div class="flex justify-center space-x-4 mb-8">
                <div class="flex flex-col items-center">
                    <label for="hours" class="text-sm text-gray-400">Ore (H)</label>
                    <input type="number" id="hours" min="0" max="99" value="0" class="w-16 p-2 bg-gray-700 border border-gray-600 rounded-lg text-center text-xl focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 transition">
                </div>
                <div class="flex flex-col items-center">
                    <label for="minutes" class="text-sm text-gray-400">Minuti (M)</label>
                    <input type="number" id="minutes" min="0" max="59" value="20" class="w-16 p-2 bg-gray-700 border border-gray-600 rounded-lg text-center text-xl focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 transition">
                </div>
                <div class="flex flex-col items-center">
                    <label for="seconds" class="text-sm text-gray-400">Secondi (S)</label>
                    <input type="number" id="seconds" min="0" max="59" value="0" class="w-16 p-2 bg-gray-700 border border-gray-600 rounded-lg text-center text-xl focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 transition">
                </div>
            </div>

            <!-- Controlli Timer (Nessun cambiamento qui) -->
            <div class="flex justify-center space-x-4 mb-6">
                <button id="startButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg shadow-green-900/50 flex items-center disabled:opacity-50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.168V8.832a1 1 0 011.555-.832l3.197 2.132c.243.161.243.515 0 .676z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Avvia
                </button>
                <button id="pauseButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg shadow-yellow-900/50 flex items-center disabled:opacity-50" disabled>
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/24/24/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Pausa
                </button>
                <button id="resetButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg shadow-red-900/50 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.958 8.958 0 0120 12a9 9 0 01-9 9m-4.502-14.075a.999.999 0 01-.252-.45c-.173-.55-.615-.71-1.165-.436-.549.273-.72.715-.546 1.265A10 10 0 0021.2 12c.708 0 1.284.576 1.284 1.284v.041c0 .708-.576 1.284-1.284 1.284-3.52 0-6.72-.258-9.6-.745a.999.999 0 01-.735-1.29 1 1 0 011.3-.735c2.474.4 4.885.545 7.185.545.24 0 .445.195.45.435.005.239-.19.44-.43.44zm-14-1.921A9.002 9.002 0 013 12a9 9 0 019-9c.708 0 1.284.576 1.284 1.284v.041c0 .708-.576 1.284-1.284 1.284-3.52 0-6.72-.258-9.6-.745a.999.999 0 01-.735-1.29 1 1 0 011.3-.735c2.474.4 4.885.545 7.185.545.24 0 .445.195.45.435.005.239-.19.44-.43.44z"></path></svg>
                    Reset
                </button>
            </div>

        </section>

        <!-- SEZIONE PRESET DIVISA IN DUE COLONNE (Nessun cambiamento qui) -->
        <section class="lg:w-1/2 presets-container">

            <!-- COLONNA 1: FOCUS WORKING -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                <h2 class="text-2xl font-semibold mb-6 text-center text-cyan-300">Focus Working (Pomodoro)</h2>
                <div id="presetsList" class="space-y-3">
                    <!-- 1. Timer Pomodoro da 20 minuti -->
                    <button data-h="0" data-m="20" data-s="0" data-category="Focus Working" data-name="Timer Pomodoro" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-xl hover:bg-gray-600 transition shadow-md hover:shadow-cyan-500/30">
                        <span class="font-medium text-cyan-200">Timer Pomodoro</span>
                        <span class="text-sm text-gray-400">00:20:00</span>
                    </button>
                    <!-- 2. Timer Pausa Breve da 5 minuti -->
                    <button data-h="0" data-m="5" data-s="0" data-category="Focus Working" data-name="Pausa Breve" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-xl hover:bg-gray-600 transition shadow-md hover:shadow-cyan-500/30">
                        <span class="font-medium text-cyan-200">Pausa Breve</span>
                        <span class="text-sm text-gray-400">00:05:00</span>
                    </button>
                    <!-- 3. Timer Pausa Lunga da 15 minuti -->
                    <button data-h="0" data-m="15" data-s="0" data-category="Focus Working" data-name="Pausa Lunga" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-xl hover:bg-gray-600 transition shadow-md hover:shadow-cyan-500/30">
                        <span class="font-medium text-cyan-200">Pausa Lunga</span>
                        <span class="text-sm text-gray-400">00:15:00</span>
                    </button>
                </div>
            </div>
            
            <!-- COLONNA 2: WORKOUT -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
                <h2 class="text-2xl font-semibold mb-6 text-center text-green-300">WorkOut (Interval Training)</h2>
                <div id="workoutPresetsList" class="space-y-3">
                    <!-- 1. Pausa Breve (30 secondi) -->
                    <button data-h="0" data-m="0" data-s="30" data-category="WorkOut" data-name="Recupero Rapido" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-xl hover:bg-gray-600 transition shadow-md hover:shadow-green-500/30">
                        <span class="font-medium text-green-200">Recupero Rapido</span>
                        <span class="text-sm text-gray-400">00:00:30</span>
                    </button>
                    <!-- 2. Pausa Lunga (1 minuto) -->
                    <button data-h="0" data-m="1" data-s="0" data-category="WorkOut" data-name="Recupero Attivo" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-xl hover:bg-gray-600 transition shadow-md hover:shadow-green-500/30">
                        <span class="font-medium text-green-200">Recupero Attivo</span>
                        <span class="text-sm text-gray-400">00:01:00</span>
                    </button>
                </div>
            </div>

        </section>

    </main>

    <!-- Modale per Messaggi (es. Timer scaduto) -->
    <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl border border-cyan-400 w-96 text-center">
            <h3 id="modalTitle" class="text-3xl font-bold text-cyan-400 mb-4">Timer Scaduto!</h3>
            <p id="modalMessage" class="text-lg text-gray-200 mb-6">Il tempo è finito. Ben fatto!</p>
            <button id="closeModalButton" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-xl transition shadow-md">Chiudi</button>
        </div>
    </div>

    <!-- Sezione JavaScript -->
    <script type="module">
        // Variabili Globali
        let countdownInterval;
        let visualizerInterval;
        let totalSecondsRemaining = 0;
        let timerRunning = false;
        let totalSecondsInitial = 0; 
        let lastPresetCategory = 'Focus Working'; 
        let fetchedTip = { text: null, sources: [] }; 
        const NUM_BARS = 20; // Numero di barre del visualizzatore

        // Elementi DOM
        const timerDisplay = document.getElementById('timerDisplay');
        const visualizerContainer = document.getElementById('visualizerContainer'); // Nuovo elemento
        const timerVisualArea = document.getElementById('timerVisualArea');
        const hoursInput = document.getElementById('hours');
        const minutesInput = document.getElementById('minutes');
        const secondsInput = document.getElementById('seconds');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resetButton = document.getElementById('resetButton');
        
        // Liste dei Preset
        const focusPresetsList = document.getElementById('presetsList');
        const workoutPresetsList = document.getElementById('workoutPresetsList');

        const messageModal = document.getElementById('messageModal');
        const closeModalButton = document.getElementById('closeModalButton');

        let audioContext;


        // --- FUNZIONI VISUALIZZATORE SPETTRALE ---
        
        /** Genera le barre del visualizzatore all'avvio */
        const createVisualizerBars = () => {
            visualizerContainer.innerHTML = ''; // Pulisce prima
            for (let i = 0; i < NUM_BARS; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                // Imposta un'altezza iniziale bassa
                bar.style.height = '10%'; 
                // Aggiunge un delay e una durata per l'effetto onda animata
                bar.style.animation = `bounce-bar-${(i % 4) + 1} 1.5s infinite alternate ease-in-out ${i * 0.05}s`;
                visualizerContainer.appendChild(bar);
            }
        };

        /** Aggiorna l'altezza delle barre in base al tempo rimanente
         * (Simula il "volume" in base al tempo, rendendolo un indicatore)
         */
        const updateVisualizer = () => {
            if (totalSecondsInitial === 0 || !timerRunning) {
                // Se non è in esecuzione, mantiene le barre a un livello basso (silenzio)
                Array.from(visualizerContainer.children).forEach(bar => {
                    bar.style.height = '10%';
                    bar.style.opacity = '0.5';
                    bar.style.animationPlayState = 'paused'; // Ferma l'animazione di pulsazione
                });
                return;
            }

            const percentageRemaining = totalSecondsRemaining / totalSecondsInitial; // 1 (pieno) a 0 (vuoto)
            
            // La "media" dell'onda si abbassa man mano che il tempo si esaurisce
            const baseLevel = 10 + (percentageRemaining * 50); // 60% a 10%
            
            Array.from(visualizerContainer.children).forEach((bar, i) => {
                // Oscillazione casuale per l'effetto onda sonora
                const randomFactor = Math.random() * 20; // Massima variazione 20%
                const barHeight = Math.min(100, baseLevel + randomFactor);
                
                bar.style.height = `${barHeight}%`;
                bar.style.opacity = '1';
                bar.style.animationPlayState = 'running'; // Avvia l'animazione
            });
        };

        /** Funzione per applicare lo stile CSS dinamico in base alla categoria */
        const applyDynamicStyles = (category) => {
            // Rimuove tutte le classi di stile dinamiche esistenti
            timerVisualArea.classList.remove('focus-style', 'workout-style');
            timerDisplay.classList.remove('timer-running');
            
            if (category === 'Focus Working') {
                timerVisualArea.classList.add('focus-style');
            } else if (category === 'WorkOut') {
                timerVisualArea.classList.add('workout-style');
            }
            
            // Aggiunge l'animazione di pulsazione solo quando il timer è avviato
            if (timerRunning) {
                timerDisplay.classList.add('timer-running');
            }
        };


        // --- FUNZIONI UI E UTILITY ---

        /** Carica i valori del preset negli input */
        const loadPreset = (preset, category) => {
            pauseTimer(); 
            
            hoursInput.value = preset.hours;
            minutesInput.value = preset.minutes;
            secondsInput.value = preset.seconds;
            
            const h = parseInt(hoursInput.value) || 0;
            const m = parseInt(minutesInput.value) || 0;
            const s = parseInt(secondsInput.value) || 0;
            totalSecondsRemaining = h * 3600 + m * 60 + s;
            totalSecondsInitial = totalSecondsRemaining;
            
            lastPresetCategory = category; 
            fetchedTip = { text: null, sources: [] }; 

            updateDisplay(); 
            updateButtonState(false);
            
            // Applica immediatamente gli stili del preset
            applyDynamicStyles(category);
            updateVisualizer(); // Aggiorna il visualizzatore allo stato "in pausa"

            showModal("Preset Caricato", `Caricato il timer: **${preset.name}**.`);
        };
        
        /** Funzione per riprodurre un suono di "Campana Tibetana" */
        const playGong = () => {
             // Utilizza la stessa logica di generazione audio del file precedente
             try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const duration = 5.0; 
                const now = audioContext.currentTime;

                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);

                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(130.81, now); 
                gain1.gain.setValueAtTime(0.5, now);
                gain1.gain.exponentialRampToValueAtTime(0.0001, now + duration);

                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);

                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(261.63, now); 
                gain2.gain.setValueAtTime(0.3, now);
                gain2.gain.exponentialRampToValueAtTime(0.0001, now + duration * 0.8); 

                osc1.start(now);
                osc2.start(now);
                osc1.stop(now + duration);
                osc2.stop(now + duration);
                
            } catch (e) {
                console.error("Errore nella riproduzione dell'audio:", e);
            }
        };
        
        /** Funzione per ottenere un consiglio da Gemini */
        const fetchGeminiTip = async (category) => {
            // Implementazione di Gemini (stessa logica del file precedente)
            fetchedTip = { text: null, sources: [] }; 
            
            let systemPrompt;
            let userQuery;

            if (category === 'WorkOut') {
                systemPrompt = "Agisci come un coach di fitness. Fornisci un consiglio rapido, semplice (sotto le 30 parole) per il recupero, lo stretching o l'idratazione dopo una breve pausa di allenamento. Non usare titoli.";
                userQuery = "Fornisci un consiglio veloce per la pausa di allenamento (30 secondi o 1 minuto) incentrato su idratazione, stretching o respirazione. Usa un tono energico e motivante. Rispondi in italiano.";
            } else if (category === 'Focus Working') {
                systemPrompt = "Agisci come un coach di crescita personale. Fornisci un consiglio rapido, semplice (sotto le 30 parole) per migliorare la concentrazione, la consapevolezza o l'apprendimento personale. Rispondi in italiano. Non usare titoli.";
                userQuery = "Fornisci un consiglio motivante e veloce per una pausa dal lavoro (5-20 minuti), concentrato sulla crescita personale, la mindfulness o l'organizzazione. Usa un tono calmo e ispiratore.";
            } else {
                return; 
            }

            const apiKey = "" 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 5;
            let delay = 1000; 

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; 
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;

                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title); 
                        }
                        fetchedTip = { text, sources };
                        return;
                    }
                } catch (error) {
                    console.error("Gemini fetch error:", error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    }
                }
            }
        };


        // --- FUNZIONI TIMER CORE ---

        /** Formatta il tempo totale in HH:MM:SS */
        const formatTime = (totalSeconds) => {
            if (totalSeconds < 0) totalSeconds = 0; 
            
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        /** Aggiorna il display del timer */
        const updateDisplay = () => {
            timerDisplay.textContent = formatTime(totalSecondsRemaining);
        };

        /** Avvia il timer */
        const startTimer = async () => {
            if (timerRunning) return;

            if (totalSecondsRemaining <= 0) {
                const h = parseInt(hoursInput.value) || 0;
                const m = parseInt(minutesInput.value) || 0;
                const s = parseInt(secondsInput.value) || 0;
                totalSecondsRemaining = h * 3600 + m * 60 + s;
                totalSecondsInitial = totalSecondsRemaining; 
            }

            if (totalSecondsRemaining <= 0) {
                showModal("Attenzione", "Imposta un tempo maggiore di zero.");
                return;
            }

            timerRunning = true;
            updateButtonState(true);
            updateDisplay();
            applyDynamicStyles(lastPresetCategory); 
            
            // Avvia l'aggiornamento del visualizzatore ogni 100ms per un effetto più fluido
            visualizerInterval = setInterval(updateVisualizer, 100); 

            countdownInterval = setInterval(async () => {
                totalSecondsRemaining--;
                updateDisplay();

                if (totalSecondsRemaining <= 0) {
                    clearInterval(countdownInterval);
                    clearInterval(visualizerInterval); // Ferma il visualizzatore
                    timerRunning = false;
                    updateButtonState(false);
                    timerDisplay.textContent = "00:00:00";
                    timerDisplay.classList.remove('timer-running');
                    updateVisualizer(); // Aggiorna il visualizzatore allo stato "finito"
                    
                    playGong(); 
                    
                    if (lastPresetCategory === 'WorkOut' || lastPresetCategory === 'Focus Working') {
                        let loadingMsg;
                        if (lastPresetCategory === 'WorkOut') {
                            loadingMsg = "Caricamento del tuo **Consiglio WorkOut**...";
                        } else { 
                            loadingMsg = "Caricamento del tuo **Consiglio Crescita Personale**...";
                        }
                        
                        showModal("Timer Scaduto!", `Il tempo è finito. Ben fatto! ${loadingMsg}`);
                        
                        await fetchGeminiTip(lastPresetCategory); 
                        
                        showModal("Timer Scaduto!", "Il tempo è finito. Ben fatto!");
                    } else {
                        showModal("Timer Scaduto!", "Il tempo è finito. Ben fatto!");
                    }
                    
                    applyDynamicStyles(lastPresetCategory);
                }
            }, 1000);
        };

        /** Mette in pausa il timer */
        const pauseTimer = () => {
            if (!timerRunning) return;
            clearInterval(countdownInterval);
            clearInterval(visualizerInterval); // Ferma il visualizzatore
            timerRunning = false;
            updateButtonState(false);
            timerDisplay.classList.remove('timer-running'); 
            updateVisualizer(); // Aggiorna il visualizzatore allo stato "in pausa"
        };

        /** Resetta il timer */
        const resetTimer = () => {
            pauseTimer();
            const h = parseInt(hoursInput.value) || 0;
            const m = parseInt(minutesInput.value) || 0;
            const s = parseInt(secondsInput.value) || 0;
            totalSecondsRemaining = h * 3600 + m * 60 + s;
            totalSecondsInitial = totalSecondsRemaining; 
            updateDisplay();
            updateButtonState(false);
            timerDisplay.classList.remove('timer-running'); 
            applyDynamicStyles(lastPresetCategory); 
            updateVisualizer(); // Aggiorna il visualizzatore allo stato "reset"
        };

        /** Gestisce lo stato dei pulsanti Start/Pausa e degli input */
        const updateButtonState = (isRunning) => {
            startButton.disabled = isRunning;
            pauseButton.disabled = !isRunning;
            hoursInput.disabled = isRunning;
            minutesInput.disabled = isRunning;
            secondsInput.disabled = isRunning;
        };
        
        // --- MODALE DI MESSAGGIO PERSONALIZZATO ---

        const showModal = (title, message) => {
            document.getElementById('modalTitle').textContent = title;
            
            let finalMessage = message;
            
            if (fetchedTip.text && (lastPresetCategory === 'WorkOut' || lastPresetCategory === 'Focus Working') && title.includes("Timer Scaduto!")) {
                let tipTitle, tipColor;

                if (lastPresetCategory === 'WorkOut') {
                    tipTitle = "Consiglio WorkOut:";
                    tipColor = "text-green-300";
                } else { 
                    tipTitle = "Consiglio Crescita Personale:";
                    tipColor = "text-cyan-300"; 
                }

                let tipHtml = `<p class="text-xl font-bold mt-4 mb-2 ${tipColor}">${tipTitle}</p>`;
                tipHtml += `<p class="text-lg text-gray-100 italic mb-4">${fetchedTip.text}</p>`;

                if (fetchedTip.sources.length > 0) {
                    tipHtml += `<p class="text-sm text-gray-500 mt-2">Fonti:</p><ul class="text-xs text-gray-500 list-disc list-inside space-y-1 text-left mx-auto max-w-xs">`;
                    fetchedTip.sources.slice(0, 2).forEach(source => {
                        tipHtml += `<li><a href="${source.uri}" target="_blank" class="hover:text-cyan-400 truncate" title="${source.title}">${source.title}</a></li>`;
                    });
                    tipHtml += `</ul>`;
                }
                
                finalMessage += tipHtml;
                fetchedTip = { text: null, sources: [] }; 
            }
            
            document.getElementById('modalMessage').innerHTML = finalMessage;
            messageModal.classList.remove('hidden');
        };

        const hideModal = () => {
            messageModal.classList.add('hidden');
        };

        // --- INIZIALIZZAZIONE ---

        // Controlli Timer
        startButton.addEventListener('click', startTimer);
        pauseButton.addEventListener('click', pauseTimer);
        resetButton.addEventListener('click', resetTimer);

        // Input Time
        [hoursInput, minutesInput, secondsInput].forEach(input => {
            input.addEventListener('change', resetTimer);
            input.addEventListener('input', (e) => {
                let val = parseInt(e.target.value) || 0;
                let max = parseInt(e.target.max);
                let min = parseInt(e.target.min);

                if (val > max) e.target.value = max;
                if (val < min) e.target.value = min;
                
                lastPresetCategory = 'Focus Working'; 
                fetchedTip = { text: null, sources: [] }; 
                
                resetTimer(); 
            });
        });

        // Gestione Preset (Load dei timer statici) - Uniamo gli ascoltatori per entrambe le liste
        [focusPresetsList, workoutPresetsList].forEach(list => {
            list.addEventListener('click', (e) => {
                const button = e.target.closest('.preset-button');
                if (!button) return;

                const name = button.dataset.name;
                const category = button.dataset.category;
                const h = parseInt(button.dataset.h) || 0;
                const m = parseInt(button.dataset.m) || 0;
                const s = parseInt(button.dataset.s) || 0;

                loadPreset({ name: name, hours: h, minutes: m, seconds: s }, category);
            });
        });

        // Chiusura Modale
        closeModalButton.addEventListener('click', hideModal);

        // Funzione di setup iniziale
        const init = () => {
            // 1. Crea le barre del visualizzatore
            createVisualizerBars(); 
            
            // 2. Carica il preset di default
            loadPreset({ name: "Default", hours: 0, minutes: 20, seconds: 0 }, 'Focus Working');
        };

        // Avvia l'inizializzazione
        init();
    </script>
</body>
</html>
