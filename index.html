<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Multiuso Minimal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- IMPORTS FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app); 
            window.auth = getAuth(app); 
            setLogLevel('Debug');

            // Autenticazione
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                    console.log("Firebase Auth initialized. User ID:", window.auth.currentUser?.uid);
                } catch (error) {
                    console.error("Error during Firebase authentication:", error);
                }
            })();
        } else {
            console.warn("Firebase configuration not found. Firestore functionality will be disabled.");
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Definizione dei Colori Sobri per l'Accent */
        :root {
            --color-focus: #3b82f6;       /* Blu Sobrio (Focus) */
            --color-workout: #14b8a6;     /* Verde Acqua (WorkOut) */
            --color-pomodoro: #ef4444;    /* Rosso (Ciclo Pomodoro) */
            --color-default: #fbbf24;     /* Giallo/Ambra (Reset/Standard) */
            --color-text-glow: #ffffff;
        }
        
        /* Animazione Minimalista del Pulsante (solo un leggero ingrandimento) */
        @keyframes subtle-pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Stile del Testo Principale */
        .timer-text {
            font-size: 5rem;
            letter-spacing: 2px;
            font-weight: 900;
            color: #ffffff;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); /* Ombra minima */
            z-index: 10;
            transition: all 0.5s ease-in-out;
        }
        
        /* Applicazione del Subtle Pulse quando in esecuzione (minimal) */
        .timer-running {
            animation: subtle-pulse 1.5s infinite alternate ease-in-out;
            opacity: 1;
        }
        
        /* Stato di Pausa */
        .timer-paused {
            opacity: 0.6;
            animation: none;
        }

        /* --- VISUALIZZATORE AUDIO SPETTRALE --- */
        .visualizer-container {
            display: flex;
            align-items: flex-end; 
            justify-content: space-between;
            width: 120%; 
            height: 100%;
            position: absolute; 
            top: 0;
            left: -10%; 
            pointer-events: none; 
        }

        .audio-bar {
            width: 7px; 
            background-color: var(--color-default);
            box-shadow: none; /* Rimosso glow dalle barre per minimalismo */
            border-radius: 3px 3px 0 0; 
            transition: height 0.1s linear;
            margin-right: 2px;
            min-height: 5%; 
        }
        
        /* Rimosse le classi di shadow box specifiche per i preset */
        .dimmed-style .audio-bar {
            opacity: 0.3;
        }

        .timer-visual-area {
            position: relative;
            width: 400px;
            height: 150px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .control-button {
            padding: 0.75rem 1.25rem; /* Reso più compatto */
            border-radius: 0.5rem; /* Bordi meno arrotondati */
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: none !important; /* Rimosse tutte le ombre esagerate dai pulsanti */
        }
        .control-button:hover:not(:disabled) {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        /* Stili per la modale (più sobria) */
        .modal-body {
            border-color: #3b82f6 !important; /* Blu d'accento */
        }
        
        /* Semplificazione della griglia su mobile */
        @media (max-width: 1023px) {
            .preset-grid {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important; /* Forzo una colonna su tutti i mobile/tablet */
            }
        }
        
        /* Fix per gli input time */
        .input-time-group input {
            width: 70px; /* leggermente più stretto per i mobile */
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <h1 class="text-4xl font-bold mb-10 text-amber-400">Timer Multiuso Minimal</h1>

    <main class="w-full max-w-7xl flex flex-col lg:flex-row gap-8">
        
        <section class="lg:w-1/2 bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-semibold mb-6 text-center text-amber-300">Il Tuo Timer</h2>

            <div class="flex justify-center">
                <div id="timerVisualArea" class="timer-visual-area default-style dimmed-style"> 
                    
                    <div id="currentState" class="text-amber-400">RESET</div>

                    <div id="timerDisplay" class="timer-text timer-paused">00:00:00</div>
                    
                    <div id="pomodoroCounter">Ciclo: 0 / 4</div>

                    <div id="visualizerContainer" class="visualizer-container">
                        </div>
                </div>
            </div>

            <div class="flex justify-center space-x-4 mb-8 mt-6 input-time-group">
                <div class="flex flex-col items-center">
                    <label for="hours" class="text-sm text-gray-400">Ore (H)</label>
                    <input type="number" id="hours" min="0" max="99" value="0" class="w-16 p-2 bg-gray-700 border border-gray-600 rounded-lg text-center text-xl focus:border-amber-400 focus:ring-1 focus:ring-amber-400 transition">
                </div>
                <div class="flex flex-col items-center">
                    <label for="minutes" class="text-sm text-gray-400">Minuti (M)</label>
                    <input type="number" id="minutes" min="0" max="59" value="0" class="w-16 p-2 bg-gray-700 border border-gray-600 rounded-lg text-center text-xl focus:border-amber-400 focus:ring-1 focus:ring-amber-400 transition">
                </div>
                <div class="flex flex-col items-center">
                    <label for="seconds" class="text-sm text-gray-400">Secondi (S)</label>
                    <input type="number" id="seconds" min="0" max="59" value="0" class="w-16 p-2 bg-gray-700 border border-gray-600 rounded-lg text-center text-xl focus:border-amber-400 focus:ring-1 focus:ring-amber-400 transition">
                </div>
            </div>

            <div class="flex justify-center space-x-4 mb-6">
                <button id="startButton" class="control-button bg-green-600 hover:bg-green-700 text-white flex items-center disabled:opacity-50">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.168V8.832a1 1 0 011.555-.832l3.197 2.132c.243.161.243.515 0 .676z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Avvia
                </button>
                <button id="pauseButton" class="control-button bg-yellow-600 hover:bg-yellow-700 text-white flex items-center disabled:opacity-50" disabled>
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/24/24/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Pausa
                </button>
                <button id="resetButton" class="control-button bg-red-600 hover:bg-red-700 text-white flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.958 8.958 0 0120 12a9 9 0 01-9 9m-4.502-14.075a.999.999 0 01-.252-.45c-.173-.55-.615-.71-1.165-.436-.549.273-.72.715-.546 1.265A10 10 0 0021.2 12c.708 0 1.284.576 1.284 1.284v.041c0 .708-.576 1.284-1.284 1.284-3.52 0-6.72-.258-9.6-.745a.999.999 0 01-.735-1.29 1 1 0 011.3-.735c2.474.4 4.885.545 7.185.545.24 0 .445.195.45.435.005.239-.19.44-.43.44zm-14-1.921A9.002 9.002 0 013 12a9 9 0 019-9c.708 0 1.284.576 1.284 1.284v.041c0 .708-.576 1.284-1.284 1.284-3.52 0-6.72-.258-9.6-.745a.999.999 0 01-.735-1.29 1 1 0 011.3-.735c2.474.4 4.885.545 7.185.545.24 0 .445.195.45.435.005.239-.19.44-.43.44z"></path></svg>
                    Reset
                </button>
            </div>

        </section>

        <section class="lg:w-1/2 flex flex-col gap-8">
            <div class="preset-grid">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                    <h2 class="text-xl font-semibold mb-6 text-blue-400">Focus Working</h2>
                    <div id="focusWorkingPresets" class="space-y-3">
                        <button data-h="0" data-m="25" data-s="0" data-category="Focus Working" data-name="Sessione di Lavoro (25m)" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition border border-blue-600 hover:border-blue-400">
                            <span class="font-medium text-blue-200">Sessione di Lavoro</span>
                            <span class="text-sm text-gray-400">00:25:00</span>
                        </button>
                        
                        <button data-h="0" data-m="5" data-s="0" data-category="Focus Working" data-name="Pausa Breve (5m)" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition border border-blue-600 hover:border-blue-400">
                            <span class="font-medium text-blue-200">Pausa Breve</span>
                            <span class="text-sm text-gray-400">00:05:00</span>
                        </button>

                        <button data-h="0" data-m="15" data-s="0" data-category="Focus Working" data-name="Pausa Lunga (15m)" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition border border-blue-600 hover:border-blue-400">
                            <span class="font-medium text-blue-200">Pausa Lunga</span>
                            <span class="text-sm text-gray-400">00:15:00</span>
                        </button>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                    <h2 class="text-xl font-semibold mb-6 text-teal-400">WorkOut & Salute</h2>
                    <div id="workoutPresets" class="space-y-3">
                        
                        <button data-h="0" data-m="1" data-s="0" data-category="WorkOut" data-name="Pausa Lunga/Ristoro (1m)" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition border border-teal-600 hover:border-teal-400">
                            <span class="font-medium text-teal-200">Pausa Lunga/Ristoro</span>
                            <span class="text-sm text-gray-400">00:01:00</span>
                        </button>
                        
                        <button data-h="0" data-m="0" data-s="30" data-category="WorkOut" data-name="Recupero Breve (30s)" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition border border-teal-600 hover:border-teal-400">
                            <span class="font-medium text-teal-200">Recupero Breve</span>
                            <span class="text-sm text-gray-400">00:00:30</span>
                        </button>

                        <button data-h="0" data-m="0" data-s="0" data-category="WorkOut" data-name="Sessione Libera (Manual)" class="preset-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition border border-teal-600 hover:border-teal-400">
                            <span class="font-medium text-teal-200">Sessione Libera</span>
                            <span class="text-sm text-gray-400">Impostazione Manuale</span>
                        </button>
                    </div>
                </div>


                <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                    <h2 class="text-xl font-semibold mb-6 text-red-400">Ciclo Pomodoro</h2>
                    <div id="pomodoroPresets" class="space-y-3">
                        <button data-work="25" data-short="5" data-long="15" data-cycles="4" data-category="Pomodoro Cycle" data-name="Avvia Ciclo 25/5" class="pomodoro-start-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition border border-red-600 hover:border-red-400">
                            <span class="font-medium text-red-200">Pomodoro 25/5 (x4 Cicli)</span>
                            <span class="text-sm text-gray-400">25' Lavoro / 5' Pausa</span>
                        </button>
                        
                        <button data-work="50" data-short="10" data-long="30" data-cycles="2" data-category="Pomodoro Cycle" data-name="Avvia Ciclo 50/10" class="pomodoro-start-button w-full flex items-center justify-between bg-gray-700 p-3 rounded-lg hover:bg-gray-600 transition border border-red-600 hover:border-red-400">
                            <span class="font-medium text-red-200">Pomodoro 50/10 (x2 Cicli)</span>
                            <span class="text-sm text-gray-400">50' Lavoro / 10' Pausa</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl border modal-body w-96 text-center">
            <h3 id="modalTitle" class="text-3xl font-bold text-blue-400 mb-4">Timer Scaduto!</h3>
            <p id="modalMessage" class="text-lg text-gray-200 mb-6"></p>
            <button id="closeModalButton" class="text-white font-bold py-2 px-6 rounded-xl transition shadow-md">Chiudi</button>
        </div>
    </div>

    <script type="module">
        // Variabili Globali per il Timer
        let countdownInterval;
        let visualizerInterval;
        let totalSecondsRemaining = 0;
        let timerRunning = false;
        let totalSecondsInitial = 0; 
        let lastPresetCategory = 'Default'; 
        let audioContext;

        // Nuove Variabili per la Modalità Pomodoro Automatica
        let isAutomaticMode = false;
        let pomodoroCount = 0; // Pomodori completati (max N prima della pausa lunga)
        let currentMode = 'IDLE'; // 'IDLE', 'WORK', 'SHORT_BREAK', 'LONG_BREAK'
        let pomodoroTimes = { work: 25 * 60, short: 5 * 60, long: 15 * 60, totalCycles: 4 };
        
        const NUM_BARS = 25; 

        // Elementi DOM
        const timerDisplay = document.getElementById('timerDisplay');
        const currentStateLabel = document.getElementById('currentState'); 
        const pomodoroCounterDisplay = document.getElementById('pomodoroCounter');
        const visualizerContainer = document.getElementById('visualizerContainer'); 
        const timerVisualArea = document.getElementById('timerVisualArea');
        const hoursInput = document.getElementById('hours');
        const minutesInput = document.getElementById('minutes');
        const secondsInput = document.getElementById('seconds');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resetButton = document.getElementById('resetButton');
        
        const messageModal = document.getElementById('messageModal');
        const closeModalButton = document.getElementById('closeModalButton');
        

        // Mappa dei colori con HEX Code (Sobria/Minimal)
        const COLOR_MAP = {
            'Focus Working': { style: 'focus-style', labelColor: 'text-blue-400', hexColor: '#3b82f6', barColorVar: 'var(--color-focus)', modalColor: 'blue' },
            'WorkOut': { style: 'workout-style', labelColor: 'text-teal-400', hexColor: '#14b8a6', barColorVar: 'var(--color-workout)', modalColor: 'teal' }, 
            'Pomodoro Cycle': { style: 'pomodoro-style', labelColor: 'text-red-400', hexColor: '#ef4444', barColorVar: 'var(--color-pomodoro)', modalColor: 'red' }, 
            'Default': { style: 'default-style', labelColor: 'text-amber-400', hexColor: '#fbbf24', barColorVar: 'var(--color-default)', modalColor: 'amber' },
        };
        
        // --- FUNZIONE POMODORO E UTILITY (Mantenute le logiche) ---

        /** Aggiorna il testo del contatore Pomodoro */
        const updatePomodoroCounter = () => {
            pomodoroCounterDisplay.textContent = `Ciclo: ${pomodoroCount} / ${pomodoroTimes.totalCycles}`;
            // Mostra il contatore solo se in modalità automatica
            pomodoroCounterDisplay.style.opacity = isAutomaticMode ? 1 : 0;
        };

        /** Inizializza o passa al ciclo successivo nel Pomodoro Automatico */
        const startNextPomodoroCycle = () => {
            clearInterval(countdownInterval);
            clearInterval(visualizerInterval);
            timerRunning = false;
            
            let timeToSet;
            let nextMode;
            const nextCategory = 'Pomodoro Cycle'; 

            if (currentMode === 'WORK' || currentMode === 'IDLE') {
                if (currentMode === 'WORK') {
                    pomodoroCount++;
                }

                if (pomodoroCount >= pomodoroTimes.totalCycles) {
                    timeToSet = pomodoroTimes.long;
                    nextMode = 'LONG_BREAK';
                    showModal("Ciclo Lunga Pausa", `Complimenti! **${pomodoroTimes.totalCycles} cicli** completati. Inizia la pausa lunga di **${pomodoroTimes.long / 60} minuti**.`);
                } else {
                    timeToSet = pomodoroTimes.short;
                    nextMode = 'SHORT_BREAK';
                    if (currentMode === 'WORK') {
                        showModal("Ciclo Pausa Breve", `Ottimo lavoro! Pomodoro ${pomodoroCount}/${pomodoroTimes.totalCycles} completato. Inizia la pausa breve di **${pomodoroTimes.short / 60} minuti**.`);
                    } else {
                        timeToSet = pomodoroTimes.work;
                        nextMode = 'WORK';
                    }
                }
            } else { // Siamo in Pausa (Breve o Lunga), torniamo al Lavoro
                timeToSet = pomodoroTimes.work;
                nextMode = 'WORK';
                
                if (currentMode === 'LONG_BREAK') {
                    pomodoroCount = 0;
                    showModal("Ricomincia il Ciclo", `La pausa lunga è terminata. Ripartono i cicli di Lavoro!`);
                } else if (currentMode === 'SHORT_BREAK') {
                    showModal("Torna al Lavoro", `La pausa breve è terminata. Torna alla sessione di Lavoro!`);
                }
            }
            
            if (currentMode === 'IDLE') {
                timeToSet = pomodoroTimes.work;
                nextMode = 'WORK';
            }
            
            currentMode = nextMode;
            lastPresetCategory = nextCategory; 
            totalSecondsRemaining = timeToSet;
            totalSecondsInitial = timeToSet;

            updateDisplay();
            updatePomodoroCounter(); 
            startTimer(); 
        };

        /** Resetta lo stato del Pomodoro Automatico */
        const resetPomodoroState = () => {
            isAutomaticMode = false;
            pomodoroCount = 0;
            currentMode = 'IDLE';
            updatePomodoroCounter(); 
            pomodoroCounterDisplay.style.opacity = 0;
        };
        
        /** Genera le barre del visualizzatore all'avvio */
        const createVisualizerBars = () => {
            visualizerContainer.innerHTML = ''; 
            for (let i = 0; i < NUM_BARS; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '10%'; 
                visualizerContainer.appendChild(bar);
            }
        };

        /** Aggiorna l'altezza delle barre in base al tempo rimanente */
        const updateVisualizer = () => {
            const isPausedOrReset = !timerRunning;
            const bars = Array.from(visualizerContainer.children);
            const currentStyleInfo = COLOR_MAP[lastPresetCategory] || COLOR_MAP['Default'];
            const barHexColor = currentStyleInfo.hexColor;
            
            if (isPausedOrReset) {
                bars.forEach(bar => {
                    bar.style.height = '15%'; 
                    bar.style.opacity = '0.4';
                    bar.style.backgroundColor = barHexColor;
                });
                return;
            }
            
            const percentageRemaining = totalSecondsRemaining / totalSecondsInitial; 
            const baseLevel = 15 + (percentageRemaining * 50); 
            
            bars.forEach((bar) => {
                bar.style.opacity = '1';
                bar.style.backgroundColor = barHexColor; 
                
                const randomFactor = Math.random() * 20; 
                const barHeight = Math.min(100, baseLevel + randomFactor);
                bar.style.height = `${barHeight}%`;
            });
        };

        /** Funzione per applicare lo stile CSS dinamico in base alla categoria */
        const applyDynamicStyles = (category, isRunning) => {
            const currentStyle = COLOR_MAP[category] || COLOR_MAP['Default'];
            
            // 1. Rimuovi tutte le vecchie classi di stile del container e del display
            timerVisualArea.classList.remove('focus-style', 'workout-style', 'pomodoro-style', 'default-style', 'dimmed-style');
            timerDisplay.classList.remove('timer-running', 'timer-paused');
            currentStateLabel.classList.remove(...Object.values(COLOR_MAP).map(c => c.labelColor), 'text-gray-400');
            
            // 2. Applica la classe di colore del PRESET
            timerVisualArea.classList.add(currentStyle.style);
            
            if (isRunning) {
                // Stato ESECUZIONE 
                timerDisplay.classList.add('timer-running');
                
                if (isAutomaticMode) {
                    currentStateLabel.textContent = currentMode === 'WORK' ? "LAVORO POMODORO" : 
                                                   currentMode === 'SHORT_BREAK' ? "PAUSA BREVE" :
                                                   currentMode === 'LONG_BREAK' ? "PAUSA LUNGA" : "LAVORO";
                } else {
                    currentStateLabel.textContent = category.toUpperCase();
                }
                
                currentStateLabel.classList.add(currentStyle.labelColor);
                
            } else { 
                // Stato PAUSA/RESET 
                timerDisplay.classList.add('timer-paused');
                currentStateLabel.textContent = isAutomaticMode && currentMode !== 'IDLE' ? `PAUSA ${currentMode.replace('_', ' ')}` : "RESET";
                currentStateLabel.classList.add('text-gray-400'); 
                
                timerVisualArea.classList.add('dimmed-style');
            }
            
            updateVisualizer();
        };

        /** Carica i valori del preset negli input e AVVIA IL TIMER (NUOVA FUNZIONE) */
        const loadAndStartPreset = (preset, category) => {
            pauseTimer(); 
            resetPomodoroState(); 

            // Imposta gli input per la modalità manuale (necessario per visualizzare il tempo prima del reset)
            hoursInput.value = preset.hours;
            minutesInput.value = preset.minutes;
            secondsInput.value = preset.seconds;
            
            const h = parseInt(hoursInput.value) || 0;
            const m = parseInt(minutesInput.value) || 0;
            const s = parseInt(secondsInput.value) || 0;
            
            totalSecondsRemaining = h * 3600 + m * 60 + s;
            totalSecondsInitial = totalSecondsRemaining;
            
            lastPresetCategory = category; 

            // Assicurati che il display sia aggiornato
            updateDisplay(); 
            
            // Avvia il timer immediatamente dopo aver impostato i valori
            startTimer(); 
            
            showModal("Preset Avviato", `Avviato il timer: **${preset.name}**.`);
        };
        
        /** Funzione per riprodurre il suono della Campana Tibetana */
        const playGong = () => {
             try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const now = audioContext.currentTime;
                const duration = 4.0; 
                
                const masterGain = audioContext.createGain();
                masterGain.connect(audioContext.destination);

                masterGain.gain.setValueAtTime(0.6, now); 
                masterGain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

                const frequencies = [432.0, 648.0, 864.5];

                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine'; 
                    oscillator.frequency.setValueAtTime(freq + (index * 0.7), now); 

                    gainNode.gain.setValueAtTime(0, now); 
                    gainNode.gain.linearRampToValueAtTime(0.3 / frequencies.length, now + 0.08); 
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(masterGain);

                    oscillator.start(now);
                    oscillator.stop(now + duration + 0.1); 
                });
                
            } catch (e) {
                console.warn("Audio non riprodotto (richiede interazione utente):", e);
            }
        };
        
        // --- FUNZIONI TIMER CORE ---

        /** Formatta il tempo totale in HH:MM:SS */
        const formatTime = (totalSeconds) => {
            if (totalSeconds < 0) totalSeconds = 0; 
            
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        /** Aggiorna il display del timer */
        const updateDisplay = () => {
            timerDisplay.textContent = formatTime(totalSecondsRemaining);
        };

        /** Avvia il timer (con VALIDAZIONE INPUT) */
        const startTimer = async () => {
            if (timerRunning) return;

            // --- VALIDAZIONE INPUT ---
            const h_val = parseInt(hoursInput.value) || 0;
            const m_val = parseInt(minutesInput.value) || 0;
            const s_val = parseInt(secondsInput.value) || 0;

            if (h_val < 0 || m_val < 0 || s_val < 0 || m_val > 59 || s_val > 59 || h_val > 99) {
                 showModal("Errore di Input", "Per favore, inserisci un tempo valido (H: 0-99, M/S: 0-59).");
                 return;
            }

            if (!isAutomaticMode) {
                // Modalità Manuale/Preset Standard: Ricalcola il tempo se è 0
                if (totalSecondsRemaining <= 0) {
                    totalSecondsRemaining = h_val * 3600 + m_val * 60 + s_val;
                    totalSecondsInitial = totalSecondsRemaining; 
                    if (totalSecondsInitial > 0 && lastPresetCategory === 'Default') {
                         lastPresetCategory = 'Default';
                    }
                }
            }
            
            if (totalSecondsRemaining <= 0) {
                showModal("Attenzione", "Imposta un tempo maggiore di zero.");
                return;
            }

            timerRunning = true;
            updateButtonState(true);
            updateDisplay();
            
            applyDynamicStyles(lastPresetCategory, true); 
            
            visualizerInterval = setInterval(updateVisualizer, 100); 

            countdownInterval = setInterval(async () => {
                totalSecondsRemaining--;
                updateDisplay();
                
                if (totalSecondsRemaining === 0) {
                    playGong(); 
                    
                    if (isAutomaticMode) {
                        startNextPomodoroCycle();
                    } else {
                        clearInterval(countdownInterval);
                        clearInterval(visualizerInterval); 
                        timerRunning = false;
                        updateButtonState(false);
                        
                        totalSecondsRemaining = totalSecondsInitial;
                        timerDisplay.textContent = formatTime(totalSecondsRemaining); 
                        
                        lastPresetCategory = 'Default';
                        applyDynamicStyles(lastPresetCategory, false); 
                        
                        showModal("Timer Scaduto!", "Il tempo è finito. Ben fatto!");
                    }
                }
            }, 1000);
        };

        /** Mette in pausa il timer */
        const pauseTimer = () => {
            if (!timerRunning) return;
            clearInterval(countdownInterval);
            clearInterval(visualizerInterval); 
            timerRunning = false;
            updateButtonState(false);
            applyDynamicStyles(lastPresetCategory, false); 
            if (isAutomaticMode) {
                showModal("Timer in Pausa", `Il ciclo Pomodoro è in pausa. Stato attuale: **${currentStateLabel.textContent}**`);
            }
        };

        /** Resetta il timer (CON PULIZIA INPUT) */
        const resetTimer = () => {
            pauseTimer();
            resetPomodoroState(); 
            
            // Imposta il display sui valori degli input (Modalità Manuale)
            const h = parseInt(hoursInput.value) || 0;
            const m = parseInt(minutesInput.value) || 0;
            const s = parseInt(secondsInput.value) || 0;
            
            // FORZA VALORI VALIDI NEGLI INPUT
            hoursInput.value = Math.max(0, Math.min(99, h));
            minutesInput.value = Math.max(0, Math.min(59, m));
            secondsInput.value = Math.max(0, Math.min(59, s));
            
            totalSecondsRemaining = h * 3600 + m * 60 + s;
            totalSecondsInitial = totalSecondsRemaining; 
            
            updateDisplay();
            updateButtonState(false);
            
            lastPresetCategory = 'Default';
            applyDynamicStyles(lastPresetCategory, false); 
            
            showModal("Reset Completo", "Il timer è stato resettato.");
        };

        /** Gestisce lo stato dei pulsanti Start/Pausa e degli input */
        const updateButtonState = (isRunning) => {
            startButton.disabled = isRunning;
            pauseButton.disabled = !isRunning;
            hoursInput.disabled = isRunning || isAutomaticMode; 
            minutesInput.disabled = isRunning || isAutomaticMode;
            secondsInput.disabled = isRunning || isAutomaticMode;
        };
        
        // --- MODALE DI MESSAGGIO PERSONALIZZATO ---

        const showModal = (title, message) => {
            document.getElementById('modalTitle').textContent = title;
            
            const category = lastPresetCategory === 'Default' ? 'Focus Working' : lastPresetCategory; 
            const styleInfo = COLOR_MAP[category] || COLOR_MAP['Default'];
            const modalColor = styleInfo.modalColor; 
            
            document.getElementById('modalTitle').className = `text-3xl font-bold mb-4 text-${modalColor}-400`;
            
            // Gestione dei colori per le classi Tailwind
            const borderColorClass = `border-${modalColor}-400`;
            const buttonBgClass = `bg-${modalColor}-600 hover:bg-${modalColor}-700`;

            
            const modalDiv = document.querySelector('#messageModal > div');
            modalDiv.className = `bg-gray-800 p-8 rounded-xl shadow-2xl w-96 text-center border ${borderColorClass}`;
            
            closeModalButton.className = `${buttonBgClass} text-white font-bold py-2 px-6 rounded-xl transition shadow-md`;

            document.getElementById('modalMessage').innerHTML = message;
            messageModal.classList.remove('hidden');
        };

        const hideModal = () => {
            messageModal.classList.add('hidden');
        };

        // --- INIZIALIZZAZIONE ---

        // Controlli Timer
        startButton.addEventListener('click', () => {
            if (!audioContext) {
                 audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            startTimer();
        });
        pauseButton.addEventListener('click', pauseTimer);
        resetButton.addEventListener('click', resetTimer);

        // Input Time (Modalità Manuale)
        [hoursInput, minutesInput, secondsInput].forEach(input => {
            input.addEventListener('input', () => {
                pauseTimer();
                resetPomodoroState();
                lastPresetCategory = 'Default'; 
                
                // Leggi i valori (che verranno validati su startTimer o resetTimer)
                const h = parseInt(hoursInput.value) || 0;
                const m = parseInt(minutesInput.value) || 0;
                const s = parseInt(secondsInput.value) || 0;
                totalSecondsRemaining = h * 3600 + m * 60 + s;
                totalSecondsInitial = totalSecondsRemaining; 
                
                updateDisplay();
                applyDynamicStyles(lastPresetCategory, false); 
            });
        });

        // Gestione Preset Standard (Focus Working e WorkOut) - ORA A PARTENZA IMMEDIATA
        document.querySelectorAll('.preset-button').forEach(button => {
            button.addEventListener('click', () => {
                const name = button.dataset.name;
                const category = button.dataset.category;
                const h = parseInt(button.dataset.h) || 0;
                const m = parseInt(button.dataset.m) || 0;
                const s = parseInt(button.dataset.s) || 0;
                
                loadAndStartPreset({ name: name, hours: h, minutes: m, seconds: s }, category);
            });
        });
        
        // Gestione Preset Pomodoro Automatico (Già a partenza immediata)
        document.querySelectorAll('.pomodoro-start-button').forEach(button => {
            button.addEventListener('click', () => {
                pauseTimer();
                
                isAutomaticMode = true;
                currentMode = 'IDLE'; 
                
                pomodoroTimes.work = parseInt(button.dataset.work) * 60;
                pomodoroTimes.short = parseInt(button.dataset.short) * 60;
                pomodoroTimes.long = parseInt(button.dataset.long) * 60;
                pomodoroTimes.totalCycles = parseInt(button.dataset.cycles) || 4;
                
                lastPresetCategory = button.dataset.category; 
                
                showModal("Avvio Ciclo Pomodoro", `Inizierai il ciclo automatico di **${pomodoroTimes.totalCycles}** Pomodori. Lavoro: ${pomodoroTimes.work/60}' Pausa Breve: ${pomodoroTimes.short/60}'`);
                
                startNextPomodoroCycle();
            });
        });

        // Chiusura Modale
        closeModalButton.addEventListener('click', hideModal);

        // Funzione di setup iniziale
        const init = () => {
            createVisualizerBars(); 
            resetTimer(); 
            updateButtonState(false);
            timerDisplay.textContent = "00:00:00"; 
            currentStateLabel.textContent = "RESET";
            
        };

        // Avvia l'inizializzazione
        init();
    </script>
</body>
</html>